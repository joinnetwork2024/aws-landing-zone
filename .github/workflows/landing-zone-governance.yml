name: "AWS Landing Zone Governance"

on:
  push:
    branches: [main]
    paths:
      - 'environments/**'
      - 'org-management/**'
      - 'policies/**'
      - 'modules/**'
  pull_request:
    branches: [main]
    paths:
      - 'environments/**'
      - 'org-management/**'
      - 'policies/**'
      - 'modules/**'

jobs:
  validate:
    name: Validate ${{ matrix.project }} (${{ matrix.environment }})
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    concurrency:
      group: ${{ github.workflow }}-${{ matrix.project }}-${{ matrix.environment }}-${{ github.event.pull_request.number || github.ref }}
      cancel-in-progress: true

    strategy:
      fail-fast: false
      matrix:
        include:
          - project: flashsale
            environment: dev
            directory: environments/dev/flashsale
          - project: iotmonitor
            environment: dev
            directory: environments/dev/iotmonitor
          - project: smart
            environment: dev
            directory: environments/dev/smart
          - project: network
            environment: prod
            directory: environments/prod/network

    defaults:
      run:
        working-directory: ${{ matrix.directory }}
        shell: bash

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: 'latest'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.14.3'

      - name: Terraform Format Check
        timeout-minutes: 2
        run: |
          echo "FMT START $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          terraform fmt -check || { echo "❌ Format failed – run terraform fmt locally"; exit 1; }
          echo "FMT END $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      - name: Terraform Init (no backend)
        timeout-minutes: 5
        run: |
          echo "INIT START $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          terraform init -backend=false
          echo "INIT END $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          terraform version
          echo "Init done – short bridge to reduce handover flake"
          sleep 3

      - name: Diagnostic pause after init (flake test)
        timeout-minutes: 1
        run: |
          echo "PAUSE START $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          sleep 10
          echo "PAUSE END - runner survived 10s idle"

      - name: Keep-runner-warm bridge
        run: |
          echo "BRIDGE $(date -u +%Y-%m-%dT%H:%M:%SZ) - keeping process active"
          date && pwd && ls -la

      - name: Terraform Validate
        timeout-minutes: 3
        run: |
          echo "VALIDATE START $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          terraform validate
          echo "VALIDATE END $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      - name: Generate Terraform Plan
        timeout-minutes: 6
        run: |
          echo "PLAN START $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          if [ -f "${{ matrix.project }}.tfvars" ]; then
            terraform plan -var-file="${{ matrix.project }}.tfvars" -out=tfplan.binary -input=false
          else
            terraform plan -out=tfplan.binary -input=false
          fi
          echo "PLAN END $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      - name: Convert Plan to JSON
        timeout-minutes: 2
        run: terraform show -json tfplan.binary > tfplan.json

      - name: OPA Policy Check
        timeout-minutes: 4
run: |
          # Use absolute path for policies to avoid "file not found" errors
          POLICY_PATH="${{ github.workspace }}/policies"
          
          if [ -d "$POLICY_PATH" ]; then
            opa eval --data "$POLICY_PATH" --input tfplan.json "data.terraform.policy.deny" --format json > result.json
            
            # Check if 'result' is empty or contains denials
            DENY_COUNT=$(jq '.result[0].expressions[0].value | length // 0' result.json)
            
            if [ "$DENY_COUNT" -gt 0 ]; then
              echo "❌ Policy Violations Found!"
              jq '.result[0].expressions[0].value' result.json
              exit 1
            fi
            echo "✅ Policies Passed"
          else
            echo "❌ Policy directory not found at $POLICY_PATH"
            exit 1
          fi
          echo "OPA END $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      - name: Cleanup temporary files
        if: always()
        run: |
          rm -f tfplan.binary tfplan.json "${{ github.workspace }}/opa_result.json" 2>/dev/null || true