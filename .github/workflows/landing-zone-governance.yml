name: "AWS Landing Zone Governance"

on:
  push:
    branches:
      - main
    paths:
      - 'environments/dev/**'
      - 'environments/prod/**'
      - 'org-management/**'
      - 'policies/**'
      - 'modules/**'
  pull_request:
    branches:
      - main
    paths:
      - 'environments/dev/**'
      - 'environments/prod/**'
      - 'org-management/**'
      - 'policies/**'      
      - 'modules/**'

jobs:
  validate:
    name: Validate ${{ matrix.project }} (${{ matrix.environment }})
    runs-on: ubuntu-latest
    timeout-minutes: 12

    strategy:
      matrix:
        include:
          # ── Development environment projects ──
          - project: flashsale
            environment: dev
            directory: environments/dev/flashsale

          - project: iotmonitor
            environment: dev
            directory: environments/dev/iotmonitor

          - project: smart
            environment: dev
            directory: environments/dev/smart

          # ── Production environment projects ──
          - project: network
            environment: prod
            directory: environments/prod/network

          # Add future AI/ML projects here, e.g.:
          # - project: model-registry
          #   environment: prod
          #   directory: environments/prod/model-registry
          #
          # - project: training-cluster
          #   environment: dev
          #   directory: environments/dev/training-cluster

    defaults:
      run:
        working-directory: ${{ matrix.directory }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: 'latest'  # Consider bumping to latest stable when ready

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.9.8'  # Good choice; 1.9.x is current but stay conservative for landing zone

      - name: Terraform Format Check
        run: |
          echo "Checking format for ${{ matrix.project }} (${{ matrix.environment }})..."
          terraform fmt -check
          if [ $? -ne 0 ]; then
            echo "❌ Terraform files need formatting. Run 'terraform fmt' locally to fix."
            exit 1
          fi

      - name: Terraform Init (no backend)
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

      - name: Generate Terraform Plan
        id: plan
        run: |
          if [ -f "${{ matrix.project }}.tfvars" ]; then
            terraform plan \
              -var-file="${{ matrix.project }}.tfvars" \
              -out=tfplan.binary \
              -input=false
          else
            terraform plan \
              -out=tfplan.binary \
              -input=false
          fi

      - name: Convert Plan to JSON
        run: terraform show -json tfplan.binary > tfplan.json

      - name: Run OPA Policy Check
        run: |
          echo "Running OPA evaluation for ${{ matrix.project }} (${{ matrix.environment }})..."

          opa eval \
            --data "${{ github.workspace }}/policies/" \
            --input tfplan.json \
            "data.terraform.policy.deny" \
            --format json \
            --fail-defined > "${{ github.workspace }}/opa_result.json" 2>/dev/null || true

          if [ -f "${{ github.workspace }}/opa_result.json" ]; then
            VIOLATIONS=$(jq '.result[0].expressions[0].value | length' "${{ github.workspace }}/opa_result.json" 2>/dev/null || echo "0")
            if [ "$VIOLATIONS" -gt 0 ]; then
              echo "❌ Found $VIOLATIONS policy violation(s):"
              jq -r '.result[0].expressions[0].value[]' "${{ github.workspace }}/opa_result.json"
              echo ""
              echo "See policy definitions in /policies/ for details."
              exit 1
            else
              echo "✅ All policies passed for ${{ matrix.project }} (${{ matrix.environment }})"
            fi
          else
            echo "⚠️ OPA evaluation did not produce results – check Rego syntax or data paths."
            exit 1
          fi

      - name: Cleanup temporary files
        if: always()
        run: |
          rm -f tfplan.binary tfplan.json "${{ github.workspace }}/opa_result.json" 2>/dev/null || true