name: "AWS Landing Zone Governance"

on:
  push:
    branches: [main]
    paths:
      - 'environments/**'
      - 'org-management/**'
      - 'policies/**'
      - 'modules/**'
  pull_request:
    branches: [main]
    paths:
      - 'environments/**'
      - 'org-management/**'
      - 'policies/**'
      - 'modules/**'

jobs:
  validate:
    name: Validate ${{ matrix.project }} (${{ matrix.environment }})
    runs-on: ubuntu-latest
    timeout-minutes: 12

    concurrency:
      group: lz-gov-${{ matrix.project }}-${{ matrix.environment }}-${{ github.ref_name }}
      cancel-in-progress: true

    strategy:
      matrix:
        include:
          - project: flashsale
            environment: dev
            directory: environments/dev/flashsale
          - project: iotmonitor
            environment: dev
            directory: environments/dev/iotmonitor
          - project: smart
            environment: dev
            directory: environments/dev/smart
          - project: network
            environment: prod
            directory: environments/prod/network

    defaults:
      run:
        working-directory: ${{ matrix.directory }}
        shell: bash

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: 'latest'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.9.8'

      - name: Terraform Format Check
        timeout-minutes: 2
        run: |
          echo "FMT START $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          terraform fmt -check || { echo "âŒ Format failed"; exit 1; }
          echo "FMT END $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      - name: Terraform Init (no backend)
        timeout-minutes: 4
        continue-on-error: true  # TEMP: to reach pause step
        run: |
          echo "INIT START $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          terraform init -backend=false
          echo "INIT END $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          terraform version

      - name: Diagnostic pause after init (flake test)
        timeout-minutes: 1
        run: |
          echo "PAUSE START $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          sleep 10
          echo "PAUSE END - runner survived 10s idle"

      - name: Terraform Validate
        timeout-minutes: 2
        run: terraform validate

      # ... (keep your existing Generate Plan, Convert to JSON, OPA Check, Cleanup steps unchanged)
      # For brevity, paste your original ones here if needed; they look solid.

      - name: Cleanup temporary files
        if: always()
        run: rm -f tfplan.binary tfplan.json "${{ github.workspace }}/opa_result.json" 2>/dev/null || true